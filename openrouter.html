<!DOCTYPE html><html><head><title>editor</title><style>
  :root{color-scheme:light dark}*{box-sizing:border-box}body{overflow:hidden}main{display:flex;flex-direction:column}
  iframe,textarea{flex:2}html,body,main{width:101%;height:100%;margin:0}textarea{font-family:monospace;white-space:pre-wrap}
  </style></head><body><main><iframe></iframe><textarea></textarea></main><script>
  (()=>{ 
  let D=document,U=URLSearchParams,L=location
  class E{
  constructor(n,db){
    [this.name,this.store,this.db]=[n,n,db]
    ;[this.t,this.f]=['textarea','iframe'].map(s=>D.querySelector(s))
    this.c=new BroadcastChannel('editor-sync')
  }
  static async c(n){
    const db=await new Promise((r,j)=>{
      let q=indexedDB.open(n,2)
      q.onupgradeneeded=e=>e.target.result.createObjectStore(n,{keyPath:'key'})
      q.onsuccess=e=>r(e.target.result)
      q.onerror=e=>j(e.target.errorCode)
    })
    let e=new E(n,db)
    await e.hp()
    e.b()
    L.hash||='#home'
    await e.ld()
    e.t.focus()
  }
  async o(m,k,v){
    let s=this.db.transaction(this.store,m).objectStore(this.store)
    return v?s.put({key:k,value:v}):new Promise(r=>s.get(k).onsuccess=x=>r(x.target.result?.value))
  }
  async hp(){
    let p=new U(L.search)
    if(p.get('prompt')){
      let key=localStorage.getItem('api.key')||localStorage.setItem('api.key',prompt('OpenRouter API Key:'))
      let sp=`url=${L.href}\ncontent=${this.t.value}`
      let r=await fetch('https://openrouter.ai/api/v1/chat/completions',{
        method:'POST',
        headers:{Authorization:'Bearer '+key,'Content-Type':'application/json'},
        body:JSON.stringify({
          model:localStorage.getItem('api.model')||'openai/gpt-3.5-turbo',
          messages:[{role:'system',content:sp},{role:'user',content:p.get('prompt')}]
        })
      }).then(x=>x.json())
      this.t.value=r.choices[0].message.content
      await this.sv()
      p.set('prompt','')
      history.replaceState(null,'',L.pathname+'?'+p.toString()+L.hash)
    }
    for(let i of p.getAll('install')){
      let[k,c]=i.split(',')
      if(k&&c&&(!await this.o('readonly',k)||confirm('Overwrite '+k+'?')))await this.o('readwrite',k,decodeURIComponent(c))
    }
  }
  b(){
    this.t.oninput=()=>{cancelAnimationFrame(this.S);this.S=requestAnimationFrame(()=>this.sv())}
    onhashchange=()=>this.ld()
    this.c.onmessage=({data:[k,v]})=>k===(L.hash.slice(1)||'home')&&(this.t.value=v)
    onbeforeunload=()=>this.c.close()
  }
  async sv(){
    let k=L.hash.slice(1)||'home'
    if(!['source','reset'].includes(k)){
      let v=this.t.value
      await this.o('readwrite',k,v)
      this.c.postMessage([k,v])
    }
  }
  async ld(){
    let h=L.hash.slice(1)||'home'
    let i=await Promise.all((new U(L.search).get('import')||'').split(',').map(k=>this.o('readonly',k)))
    let c=await this.o('readonly',h)
    this.t.value=c||''
    this.up([...i,c].join(''))
  }
  up(c){
    let d=this.f.contentDocument
    d?.write(`<!DOCTYPE html><style>:root{color-scheme:light dark}*{white-space:pre-wrap;box-sizing:border-box}</style>${c}`)
    d?.close()
  }
  }
  E.c('editor')
  })();
</script></body></html>
